# 企業セクション フロー図解

## 1. 全体アーキテクチャ

```
┌──────────────────────────────────────────────────────────┐
│                  Torail 企業セクション                   │
└──────────────────────────────────────────────────────────┘

   ┌─────────────────────┐
   │ LoginCompanyPage    │  ← 企業ログイン・登録
   │ /company/login      │     account_type="company"
   └──────────┬──────────┘
              │
              ↓ (ログイン成功)
   ┌──────────────────────────┐
   │ CompanyDashboard         │  ← メイン画面（候補者検索）
   │ /company/dashboard       │
   │                          │
   │ ├─ FiltersBar           │     検索フィルタ操作
   │ ├─ SavedSearches        │     保存済み検索
   │ └─ CandidateList        │     候補者リスト
   └───┬──────────────┬──────┘
       │              │
   (設定)       (スカウト)
       │              │
       ↓              ↓
   ┌─────────────┐   /company/scout
   │CompanySettings│  ?to={username}
   │/company/settings&uid={user_id}
   │             │   │
   │ ├─ Profile  │   └─→ Scout
   │ ├─ Hirings  │        (スカウト作成)
   │ ├─ Settings │
   │ ├─ Plans    │
   │ └─ Members  │
   └─────────────┘

   ┌──────────────────────┐
   │ PublicCompanyPage    │  ← 公開ページ
   │ /company/public/:slug│     未認証アクセス可
   │ (読取専用)           │
   └──────────────────────┘
```

---

## 2. 企業オンボーディングフロー

```
┌─────────────────────────────────┐
│   /company/login                │
│   (未ログインユーザー)           │
└────────────┬────────────────────┘
             │
             ↓
┌─────────────────────────────────┐
│ Login_Register コンポーネント   │
│                                 │
│ ├─ Tab: "login"  (ログイン)    │
│ └─ Tab: "register" (登録)      │
│    [デフォルト表示]             │
└────────────┬────────────────────┘
             │
             ↓ (「登録」ボタンクリック)
┌─────────────────────────────────┐
│ POST /auth/register/            │
│ {                               │
│   "email": "...",               │
│   "password": "...",            │
│   "account_type": "company"     │ ← 固定値
│ }                               │
└────────────┬────────────────────┘
             │
       ┌─────┴─────┐
       │ (成功)    │ (失敗)
       ↓           ↓
   Token保存    エラーメッセージ表示
       │           ↑
       └─→ localStorage に Token
           │
           ↓ (リダイレクト)
┌─────────────────────────────────┐
│ /company/dashboard              │
│ GET /companies/                 │
└────────────┬────────────────────┘
             │
        ┌────┴─────────┐
        │(companies)   │
    未所属 []       所属済み [...]
        │              │
        ↓              ↓
┌─────────────────┐  ┌──────────────┐
│企業作成フロー    │  │通常ダッシュ   │
│                 │  │              │
│【パターンA】    │  │◆ 候補者検索  │
│最初の1人        │  │◆ フィルタ   │
│→企業を新規作成  │  │◆ 保存済み検索│
│  POST /companies/│  │◆スカウト起点│
│                 │  │              │
│【パターンB】    │  └──────────────┘
│既に企業有      │
│→オーナー待ち    │
└─────────────────┘
     │
     ↓ (企業作成成功 または オーナーから追加)
     │
     └→ 通常ダッシュ表示に切り替え
```

---

## 3. 候補者検索フロー（詳細版）

```
CompanyDashboard
     │
     ├─ useEffect (マウント時)
     │  └─ GET /companies/
     │     ↓
     │     companies リスト取得
     │
     └─ FiltersBar 表示
        (言語、学年、地域、キーワード、ソート)
        │
        ↓ (ユーザーがフィルタを操作)
        │
        ├─ onChange(newFilters)
        │  ├─ setFilters(newFilters)
        │  └─ setPage(1)
        │
        ↓
        useEffect (filters 依存)
           │
           ├─ buildQuery(filters)
           │  └─ URLSearchParams に変換
           │     languages=python,js
           │     grade=B4
           │     region=東京都
           │     sort=active7
           │
           └─ runSearch(1, filters)
              │
              ├─ Try:
              │  ├─ GET /companies/candidates/?page=1&{queryString}
              │  ├─ setItems([候補者リスト])
              │  └─ setTotal(count)
              │
              └─ Catch:
                 ├─ status=404?
                 │  │
                 │  ├─ Retry: GET /profiles/search/?...
                 │  │  └─ setItems(...)
                 │  │
                 │  └─ Also Fail?
                 │     └─ setItems([])
                 │        (空表示)
                 │
                 └─ Other Error
                    └─ throw e (上位へ)
        │
        ↓
        CandidateList 描画
        (items を元に候補者カード表示)
        │
        ├─ page={page}
        ├─ pageSize={pageSize}
        ├─ total={total}
        │
        └─ onPage={setPage}
           ↓ (ユーザーがページネーション操作)
           │
           useEffect (page 依存)
           └─ runSearch(page, filters)
              └─ (上記 runSearch と同じフロー)
```

---

## 4. 候補者カード内のイベント

```
各候補者カード
     │
     ├─ onProfile ボタン (プロフィール表示)
     │  └─ onProfile(candidate)
     │     └─ navigate(`/mypage/${username}`)
     │        ↓
     │        UserPage へ遷移
     │
     ├─ onScout ボタン (スカウト送信)
     │  └─ onScout(candidate)
     │     └─ navigate(`/company/scout?to=${username}&uid=${user_id}`)
     │        ↓
     │        Scout ページへ遷移
     │        (スカウトメッセージ作成)
     │
     └─ onToggleFav ボタン (お気に入りトグル)
        └─ onToggleFav(candidate)
           ├─ setItems(prev =>
           │  prev.map(x =>
           │    x.id === candidate.id
           │      ? { ...x, fav: !x.fav }
           │      : x
           │  )
           │)
           │
           └─ [オプション]
              └─ API: POST/DELETE /company_favorites/{id}/
                 (実装されていればここで同期)
```

---

## 5. 検索条件の保存フロー

```
FiltersBar の onSaveCond ボタン
     │
     ↓
┌─────────────────────────────┐
│ onSaveCond() 実行           │
└──────────────┬──────────────┘
               │
               ├─ 現在の filters から
               │  ラベルを自動生成
               │
               │  label = [
               │    filters.languages.join("・")
               │      → "Python・JavaScript"
               │    filters.currentStreakMin
               │      → "streak≥3"
               │  ].join("×")
               │  → "Python・JavaScript×streak≥3"
               │
               └─ setSaved(prev => [...prev, { name: label }])
                  ↓
                  SavedSearches に新しい保存条件が表示
                  (クリック可能)

SavedSearches の各アイテムをクリック
     │
     ↓ (将来実装)
     │ 保存された条件で検索を再実行
     │
     └─ setFilters(保存条件)
        └─ runSearch() 実行
```

---

## 6. 企業設定画面のマウントフロー

```
CompanySettings
     │
     └─ useEffect (マウント時)
        │
        ├─ 並列リクエスト開始
        │
        ├─ ① GET /companies/
        │  └─ setCompany(list[0])
        │
        ├─ ② GET /company_members/?company={id}
        │  └─ role="owner" を探す
        │     └─ setIsAdmin(!!found)
        │
        ├─ ③ GET /company_plans/?company={id}
        │  └─ setPlans(...)
        │
        └─ ④ GET /company_hirings/?company={id}
           └─ setHirings(...)
              (404 でもエラー無視)
```

---

## 7. 募集情報の CRUD フロー

```
【CREATE】
   │
   ├─ 「募集を追加」ボタンクリック
   │  ├─ draft = {
   │  │   title: "",
   │  │   detail: "",
   │  │   tech_stack: "",
   │  │   location: "",
   │  │   employment_type: "新卒"
   │  │ }
   │  └─ setHirings(prev => [draft, ...prev])
   │     (UI に即座に反映)
   │
   └─ ユーザーがフォーム入力
      │
      ├─ HiringInfoCard onChange 発火
      │  └─ draft が戻ってくる
      │
      └─ draft.__raw.id が undefined?
         ├─ YES: POST /company_hirings/
         │  {
         │    company: id,
         │    title: ...,
         │    detail: ...,
         │    tech_stack: ...,
         │    location: ...,
         │    employment_type: ...
         │  }
         │  ↓
         │  created オブジェクト取得
         │  ↓
         │  draft を created で置換
         │
         └─ NO: PATCH /company_hirings/{draft_id}/
            (更新処理)


【READ】
   │
   ├─ マウント時に GET /company_hirings/?company={id}
   │  └─ setHirings(...)
   │
   └─ 一覧表示


【UPDATE】
   │
   ├─ HiringInfoCard onChange
   │  └─ draft_with_id が戻ってくる
   │
   └─ PATCH /company_hirings/{id}/
      ├─ updated オブジェクト取得
      └─ setHirings(prev =>
           prev.map(x => x.id === updated.id ? updated : x)
         )


【DELETE】
   │
   ├─ 削除ボタンクリック
   │  └─ confirm() 確認
   │
   ├─ YES:
   │  ├─ DELETE /company_hirings/{id}/
   │  └─ setHirings(prev =>
   │       prev.filter(x => x.id !== deleted_id)
   │     )
   │
   └─ NO: 何もしない
```

---

## 8. プラン適用フロー

```
CompanySettings (右カラム)
     │
     ├─ 「プランを比較して選ぶ」ボタン
     │  └─ setShowPlanModal(true)
     │
     ├─ プラン比較モーダル表示
     │  (Free / Pro / Enterprise の3プラン比較表)
     │
     └─ 各プランの「このプランにする」ボタン
        │
        └─ applyPresetPlan(preset)
           │
           ├─ isAdmin チェック
           │  ├─ NO: alert('オーナー権限が必要です')
           │  └─ return
           │
           ├─ confirm() 確認
           │  └─ "Pro を適用しますか？"
           │
           ├─ YES: setSaving(true)
           │       POST /company_plans/
           │       {
           │         company: company.id,
           │         plan_type: "pro",
           │         monthly_quota: 200,
           │         price_jpy: 5000,
           │         active_from: today
           │       }
           │
           ├─ 成功:
           │  ├─ setPlans(prev => [created, ...prev])
           │  │  (新プランを先頭に追加)
           │  │
           │  ├─ alert("Pro プランを適用しました")
           │  ├─ setShowPlanModal(false)
           │  └─ setSaving(false)
           │
           └─ 失敗:
              ├─ alert("プランの適用に失敗しました")
              └─ setSaving(false)
```

---

## 9. 公開ページのアクセスフロー

```
非ログインユーザー or 別社ユーザー
     │
     └─ /company/public/torail-inc にアクセス
        │
        └─ PublicCompanyPage
           │
           ├─ useParams() → slug="torail-inc"
           │
           └─ useEffect ([slug])
              │
              ├─ setLoading(true)
              │
              ├─ GET /public/companies/torail-inc/
              │  (未認証でアクセス可)
              │
              ├─ res.data:
              │  {
              │    company: {
              │      name, industry, description,
              │      website, logo_url
              │    },
              │    hirings: [
              │      { title, tech_stack, location, ... },
              │      ...
              │    ]
              │  }
              │
              ├─ setData(res)
              │
              └─ setLoading(false)
                 │
                 ↓

           JSX 描画:
              │
              ├─ loading が true?
              │  └─ "読み込み中..."
              │
              ├─ data が null?
              │  └─ "企業情報が見つかりません"
              │  (理由: is_public=false または 404)
              │
              └─ else:
                 ├─ ページヘッダ表示
                 ├─ CompanyProfileCard (isAdmin=false)
                 │  (読取専用、編集ボタン非表示)
                 │
                 ├─ HiringInfoCard (isAdmin=false)
                 │
                 └─ 求人リスト
                    (title, tech_stack, location 表示)
```

---

## 10. データ同期パターン

### 手法1: 楽観的 UI 更新（Optimistic Update）

```
ユーザーアクション
     ↓
① 即座に UI 更新（state を先に更新）
     ↓
② 同時に API リクエスト送信
     ↓
┌──────┴──────┐
│  成功       │  失敗
├─────────────┼────────────────┐
│ ✓ 完了     │ ✗ alert() して
│            │   ロールバック
└────────────┴────────────────┘
```

**例**: 募集情報フォーム入力

```javascript
// ドラフトをすぐに表示
setHirings(prev => [draft, ...prev]);

// 同時に API へ
const created = await api(`/company_hirings/`, { method: "POST", ... });

// 成功時: ドラフトを created で置換
setHirings(prev => prev.map(x => x === draft ? created : x));
```

### 手法2: キャッシュ無効化（Refetch）

```
API リクエスト
     │
     └─ 成功 ✓
        │
        └─ GET で再取得
           └─ 最新データで state 更新
```

**例**: 企業作成成功後

```javascript
await api("/companies/", { method: "POST", ... });

// 成功後に企業リストを再取得
const list = await api("/companies/", { method: "GET" });
setCompanies(list?.results || list || []);
```

---

## 11. エラーハンドリングの全体フロー

```
API リクエスト実行
     │
     └─ try-catch
        │
        ├─ Success (2xx)
        │  └─ データ処理 → state 更新
        │
        └─ Catch (Error)
           │
           ├─ DRF エラー?
           │  ├─ 400: バリデーションエラー
           │  │  └─ e?.response?.data?.field_errors
           │  │
           │  ├─ 401: 未認証
           │  │  └─ token 削除 → /company/login へ
           │  │
           │  ├─ 403: 権限なし
           │  │  └─ alert("権限がありません")
           │  │
           │  ├─ 404: リソース未検出
           │  │  ├─ 検索: フォールバック API へ
           │  │  └─ 企業: "見つかりません"
           │  │
           │  └─ 5xx: サーバーエラー
           │     └─ alert("サーバーエラー: ...")
           │
           └─ その他エラー
              └─ console.error()
```

---

## 12. 状態遷移図（企業設定画面）

```
【初期状態】
company = null
isAdmin = false
plans = []
hirings = []
     │
     ↓ (useEffect)
     │
【データ取得中】
loading... (画面は「読み込み中…」)
     │
     ├─ ① GET /companies/
     ├─ ② GET /company_members/
     ├─ ③ GET /company_plans/
     └─ ④ GET /company_hirings/
     │
     ↓ (全て成功)
     │
【データ取得完了】
company = { id, name, ... }
isAdmin = true or false
plans = [...]
hirings = [...]
     │
     ├─ 左カラム: プロフィール表示可能
     │
     ├─ 募集情報セクション
     │  ├─ Read: 既存募集をカード表示
     │  ├─ Create: 「追加」ボタンで draft 挿入
     │  ├─ Update: onChange で PATCH
     │  └─ Delete: 削除ボタンで DELETE
     │
     ├─ 公開設定セクション
     │  ├─ isAdmin=true: フォーム操作可能
     │  └─ isAdmin=false: disabled
     │
     └─ 右カラム: プラン管理
        ├─ 現在のプラン表示
        └─ プラン比較モーダル
           └─ 新プラン適用可能
```

---

このフロー図解により、企業セクション全体の処理が視覚化されます。
各ページの状態遷移、データフロー、イベントハンドリングを把握して、
カスタマイズや拡張が容易になります。

