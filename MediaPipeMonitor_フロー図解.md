# MediaPipeMonitor.jsx フロー図解

## 1️⃣ 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                  親コンポーネント（AddRecords）              │
│  - timerStateNum: 0=実行中, 1=中断中                        │
│  - onAway, onFist, onPalm: コールバック                     │
└────────────────────┬────────────────────────────────────────┘
                     │ Props 渡す
                     ▼
        ┌────────────────────────────────┐
        │   MediaPipeMonitor コンポーネント    │
        │  ・顔検出（FaceDetector）      │
        │  ・手ランドマーク（HandLandmarker）│
        │  ・ジェスチャ判定                │
        │  ・カメラ監視 ON/OFF            │
        └────────┬───────────────────────┘
                 │
        ┌────────▼────────────────┐
        │  MediaPipe Models        │
        │  (CDN v0.10.21)          │
        │  ・BlazeFace(顔)         │
        │  ・Hands(21点ランドマーク)│
        └────────┬────────────────┘
                 │ WASM 推論
        ┌────────▼────────────────┐
        │  WebRTC カメラストリーム  │
        │  (getUserMedia)          │
        └─────────────────────────┘
```

---

## 2️⃣ 初期化フロー（useEffect）

```
┌─ useEffect 実行 ─┐
│ [effectiveEnabled]│  (enabled && monitorOn が両方 true)
└────────┬────────┘
         │
         ├─ enabled=false または monitorOn=false?
         │  YES → cleanup() → return
         │
         └─ NO
            │
            ├─ 既に faceRef/handRef 初期化済み?
            │  YES → return (二重初期化防止)
            │
            └─ NO
               │
               ▼ (非同期処理開始)
        ┌──────────────────────────────┐
        │ ステップ 1: バッジ = INIT     │
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 2: WASM ローダ初期化  │
        │ FilesetResolver.forVisionTasks│
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 3: FaceDetector 作成  │
        │ BlazeFace short-range         │
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 4: HandLandmarker 作成│
        │ MediaPipe Hands (21 点)       │
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 5: カメラ取得        │
        │ getUserMedia()                │
        └──────┬───────────────────────┘
               │
        cancelled? → YES → return (state 更新スキップ)
               │
               NO
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 6: video に接続      │
        │ video.srcObject = stream      │
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 7: メタデータ待機    │
        │ video.readyState >= 1        │
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 8: 再生開始          │
        │ video.play()                  │
        └──────┬───────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ステップ 9: loop 開始        │
        │ requestAnimationFrame(loop)  │
        │ バッジ = ACTIVE              │
        └──────────────────────────────┘
               │
               ▼
        ┌──────────────────────────────┐
        │ ✓ 推論スタート！              │
        └──────────────────────────────┘

エラー発生時:
  NotAllowedError/NotFoundError → BLOCKED バッジ
  その他 → ERROR バッジ
```

---

## 3️⃣ メインループ（loop()）フロー

```
┌─────────────────────────────┐
│  loop() - requestAnimationFrame で連続実行 │
└──────────┬──────────────────┘
           │
           ▼
    ┌──────────────────────┐
    │ effectiveEnabled?    │
    │ (enabled && monitorOn)│
    └─┬──────────────┬──────┘
      │NO           │YES
      │             ▼
      │     ┌────────────────────────┐
      │     │ フレーム間引き判定     │
      │     │ ts - lastInferAt       │
      │     │ < frameIntervalMs?     │
      │     └─┬──────────────┬───────┘
      │       │YES          │NO
      │       │             ▼
      │       │     ┌──────────────────────┐
      │       │     │ lastInferAt = 現在時刻│
      │       │     └──────┬───────────────┘
      │       │            │
      │       │            ▼
      │       │     ┌──────────────────────┐
      │       │     │ video.videoWidth > 0?│
      │       │     └─┬──────────────┬─────┘
      │       │       │NO            │YES
      │       │       │              ▼
      │       │       │     ┌─────────────────────┐
      │       │       │     │【顔検出】           │
      │       │       │     │detectForVideo(video)│
      │       │       │     └──────┬──────────────┘
      │       │       │            │
      │       │       │            ▼
      │       │       │     ┌──────────────────────┐
      │       │       │     │ faceDetected?        │
      │       │       │     └─┬──────────────┬─────┘
      │       │       │       │NO            │YES
      │       │       │       │              │
      │       │       │   ┌───▼──────┐   ┌──▼───────┐
      │       │       │   │タイマー   │   │タイマー   │
      │       │       │   │実行中    │   │実行中    │
      │       │       │   │(S=0)    │   │(S=0)    │
      │       │       │   └───┬──────┘   └──┬───────┘
      │       │       │       │             │
      │       │       │   ┌───▼─────────┐  ┌─▼─────────┐
      │       │       │   │顔なし開始    │  │カウント   │
      │       │       │   │時刻記録      │  │リセット   │
      │       │       │   │カウントダウン│  │ACTIVE    │
      │       │       │   │表示         │  └──────────┘
      │       │       │   │             │
      │       │       │   │ 0秒以下?    │
      │       │       │   │ YES→onAway()│
      │       │       │   └─────────────┘
      │       │       │
      │       │       └─────┬───────────┐
      │       │             │           │
      │       │             ▼           ▼
      │       │         タイマー状態判定:
      │       │         - S=0（実行中）
      │       │         - S=1（中断中）
      │       │         - S=3（その他）
      │       │
      │       └──────────┬──────────────┐
      │                  │              │
      │                  ▼              ▼
      │        ┌──────────────────────┐
      │        │【手ランドマーク検出】 │
      │        │detectForVideo(video) │
      │        │numHands: 1           │
      │        └──────┬───────────────┘
      │               │
      │               ▼
      │        ┌──────────────────────┐
      │        │ 手が検出されている?   │
      │        │ && !inCooldown()?    │
      │        └─┬──────────┬─────────┘
      │          │NO        │YES
      │          │          ▼
      │          │  ┌────────────────────┐
      │          │  │【ジェスチャ判定】  │
      │          │  │isPalmOpen(lm[0])?  │
      │          │  └─┬──────────┬───────┘
      │          │    │          │
      │          │    │YES       │NO
      │          │    │          │
      │          │  ┌─▼──┐    ┌─▼──┐
      │          │  │パー│    │グー│
      │          │  └────┘    └────┘
      │          │    │          │
      │          │    ▼          ▼
      │          │ タイマー状態で処理:
      │          │ - S=0 かつグー
      │          │   → onFist()（中断）
      │          │ - S=1 かつパー
      │          │   → onPalm()（再開）
      │          │ - S=1 かつ autoResume
      │          │   && away由来
      │          │   → onPalm()（自動再開）
      │          │
      │          └──────┬───────────────┘
      │                 │
      │                 ▼
      │        ┌──────────────────────┐
      │        │【プレビュー描画】     │
      │        │showPreview=true?     │
      │        │drawOverlay(canvas)   │
      │        └──────┬───────────────┘
      │               │
      │               ▼
      │        ┌──────────────────────┐
      │        │ エラー処理            │
      │        │ catch(err)            │
      │        │ → ERROR バッジ        │
      │        └──────┬───────────────┘
      │               │
      │               ▼
      ├─── requestAnimationFrame(loop) ───┐
      │                                    │
      └────────────────────────────────────┘
              (次フレームループ)
```

---

## 4️⃣ タイマー状態別処理

```
┌──────────────────────────────────────────────────────────────┐
│               顔検出 → タイマー状態で分岐                      │
└──────────────────────────────────────────────────────────────┘

【ケース 1】timerStateNum === 0（実行中）
────────────────────────────────

  顔あり                          顔なし
     │                              │
     ▼                              ▼
  ┌───────────┐              ┌──────────────┐
  │ACTIVE     │              │NO_FACE       │
  │カウント   │              │カウント開始   │
  │リセット   │              │毎フレーム ↑  │
  └───────────┘              │             │
                             │ 10秒経過?   │
                             │      │      │
                             │    YES      │
                             │      │      │
                             │      ▼      │
                             │  onAway()   │
                             │  ↓          │
                             │  親で中断   │
                             │  S → 1     │
                             └──────────────┘


【ケース 2】timerStateNum === 1（中断中）
────────────────────────────────

  顔なし                          顔あり
     │                              │
     ▼                              ▼
  ┌───────────┐              ┌──────────────┐
  │IDLE       │              │ACTIVE        │
  │何もしない  │              │自動再開判定   │
  └───────────┘              │              │
                             ├─ autoResume? │
                             │   NO → 何も  │
                             │       しない │
                             ├─ away由来?   │
                             │   NO → 何も  │
                             │       しない │
                             ├─ クールダウン│
                             │   中? 何もしない
                             │   NO ↓       │
                             │  onPalm()    │
                             │  ↓           │
                             │  親で再開    │
                             │  S → 0      │
                             └──────────────┘


【ケース 3】timerStateNum === 3（その他/記録済み）
────────────────────────────────

  顔あり/なし
      │
      ▼
  ┌──────────────┐
  │ACTIVE/IDLE   │
  │何もしない     │
  │（ジェスチャも│
  │  反応しない） │
  └──────────────┘
```

---

## 5️⃣ ジェスチャ判定ロジック

```
【入力】手ランドマーク（21点）
   0: 手首（wrist）
   1-4: 親指（thumb）
   5-8: 人差し指（index）
   9-12: 中指（middle）
   13-16: 薬指（ring）
   17-20: 小指（pinky）

┌─────────────────────────────────────────────────────────┐
│              isPalmOpen(lm) 判定                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
            ┌─────────────────────┐
            │ palmOpenness(lm)    │
            │ = Σ dist(wrist,tip) │
            │ (5本の指の先端)     │
            └──────┬──────────────┘
                   │
                   ├─ グー:   0.49 （小さい）
                   ├─ 中間:   0.62
                   └─ パー:   1.50 （大きい）
                        │
                        ▼
                  threshold: 0.75
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
      < 0.60          0.60-0.75        > 0.75
        │               │               │
      グー        どちらともいえない   パー
      FALSE             │            TRUE
                   (反応なし)


【グー判定アルゴリズム】
    （現在の実装は isPalmOpen の逆判定を使用）

    ※参考：isFistStrict() の未使用判定
      - 4本指が曲がっているか
        PIP > Tip の距離で判定
      - 親指がたたまれているか
        親指先端が手のひら中心に近いか
      - 手の開き度が小さいか
        palmOpenness < 0.60

        全て満たす → グー（厳密版）
```

---

## 6️⃣ ステート遷移図

```
┌─────────────────────────────────────────────────────────┐
│               バッジ（UI 状態表示）の遷移                 │
└─────────────────────────────────────────────────────────┘

  初期状態
    │
    ▼
  ┌──────────┐
  │INIT      │ (初期化中)
  │secondary │ バッジ色：灰
  └─┬────┬───┘
    │    └─ エラー発生 ──────┐
    │                       │
    └─ 初期化完了           ▼
       と同時に        ┌──────────┐
       ▼              │ERROR     │
  ┌──────────┐        │danger    │
  │ACTIVE    │◄───────│バッジ色：赤
  │success   │        └──────────┘
  │バッジ色：green     ↑ (エラーハンドリング)
  └─┬───┬────┘
    │   │         ┌──────────┐
    │   └────────►│NO_FACE   │
    │ 顔が見える  │warning   │
    │            │バッジ色：yellow
    │            └────┬─────┘
    │                 │
    │ (10秒後)        │
    │ onAway()        │
    │      │          │
    │      └─ 親で ───┘
    │        中断
    │
    └─ 顔見える
       状態に戻す


  (親で中断処理)
    timerStateNum: 0 → 1
           ▼
  ┌──────────┐
  │IDLE      │
  │secondary │
  │バッジ色：灰
  └────┬─────┘
       │ 顔で自動再開判定
       │ (条件満たす)
       │
       └─ onPalm() 発火
          (親で再開処理)
          timerStateNum: 1 → 0
               ▼
          back to ACTIVE


  権限エラー時
  (NotAllowedError/NotFoundError)
       │
       ▼
  ┌──────────┐
  │BLOCKED   │
  │danger    │
  │バッジ色：赤
  │※カメラ権限を確認してください
  └──────────┘
```

---

## 7️⃣ クールダウン機構

```
ジェスチャ発火後、同じジェスチャが連続で発火しないよう
gestureCooldownMs (デフォ 1200ms) のクールダウンを設ける

┌─────────────────────────────────────────┐
│ onFist() または onPalm() が発火        │
└──────────────┬──────────────────────────┘
               │
               ▼
        lastGestureAtRef.current = Date.now()
               │
               ▼
  ┌─────────────────────────────────┐
  │ 同じジェスチャ判定されても...    │
  │                                 │
  │ inCooldown() = (Date.now() -     │
  │   lastGestureAtRef.current) <   │
  │   gestureCooldownMs?            │
  │                                 │
  │ YES → スキップ（何もしない）    │
  │ NO → コールバック発火OK         │
  └─────────────────────────────────┘

例）gestureCooldownMs = 1200ms の場合:

  t=0ms    グー発火 → onFist() 実行
           lastGestureAtRef = 0

  t=100ms  グー検出 → inCooldown()=TRUE → スキップ
  t=500ms  グー検出 → inCooldown()=TRUE → スキップ
  t=1100ms グー検出 → inCooldown()=TRUE → スキップ
  t=1300ms グー検出 → inCooldown()=FALSE → onFist() 実行 OK
```

---

## 8️⃣ 自動再開の条件判定

```
timerStateNum === 1（中断中）かつ顔が戻った時

┌──────────────────────────────────────┐
│ 4つの条件をすべて満たす場合のみ       │
│ 自動再開（onPalm()）実行              │
└────┬───────────────────────────────────┘
     │
     ├─ ❶ faceDetected === true
     │     (顔が見える)
     │
     ├─ ❷ autoResume === true
     │     (自動再開機能が有効)
     │
     ├─ ❸ lastPausedReasonRef.current === "away"
     │     (顔なし自動中断が原因)
     │     ※ユーザーがグーで中断 → reason="manual" → 再開しない
     │
     └─ ❹ !inCooldown()
           (クールダウン中でない)

     全て true ↓

     ┌──────────────────┐
     │ onPalm() 発火    │
     │ ↓                │
     │ 親で再開処理     │
     │ timerStateNum: 1→0
     │ ↓                │
     │ タイマー再開     │
     └──────────────────┘

いずれか1つでも満たさない → 何もしない
```

---

## 9️⃣ cleanup() フロー

```
┌────────────────────────────────────┐
│ cleanup() - 全リソース解放           │
└─────────────┬──────────────────────┘
              │
              ├─ cancelAnimationFrame(rafRef.current)
              │  (loop ストップ)
              │
              ├─ video.pause() && video.srcObject = null
              │  (video 要素クリア)
              │
              ├─ mediaStream.getTracks().forEach(t => t.stop())
              │  (カメラ物理的に OFF)
              │
              ├─ faceRef.current.close()
              │  (FaceDetector リソース破棄)
              │
              ├─ handRef.current.close()
              │  (HandLandmarker リソース破棄)
              │
              ├─ ref をすべて null に
              │  (ガベージコレクション対象に)
              │
              ├─ UI ステートをリセット
              │  (secondsToPause, _hasFace など)
              │
              └─ 制御参照をすべてリセット
                 (awayStartRef, lastGestureAtRef など)

              ▼
        全リソース解放完了
        次回監視開始時に fresh state から開始
```

---

## 🔟 プレビュー描画フロー

```
drawOverlay(canvas, video, faceBoxes, handLandmarksList)

┌──────────────────────────────┐
│ キャンバスサイズ設定          │
│ 320×240（固定）              │
└───────────┬──────────────────┘
            │
            ▼
   ┌─────────────────────┐
   │キャンバスクリア      │
   │clearRect(0,0,W,H)   │
   └──────┬──────────────┘
          │
          ▼
   ┌─────────────────────┐
   │背景: video フレーム  │
   │drawImage(video)     │
   │(スケーリング適用)   │
   └──────┬──────────────┘
          │
          ▼
   ┌─────────────────────────────┐
   │顔矩形描画（緑：lime）        │
   │for each faceBox:            │
   │  計算：originX/Y, width/height
   │  スケーリング座標に変換     │
   │  strokeRect(x,y,w,h)        │
   └──────┬──────────────────────┘
          │
          ▼
   ┌─────────────────────────────┐
   │手ランドマーク描画（白：white）│
   │21点と指の骨格               │
   │                             │
   │for each hand:              │
   │  for each finger:           │
   │    関節を直線で繋ぐ         │
   │  for each landmark:         │
   │    円で点を表示             │
   │    (半径 2.2px)             │
   └─────────────────────────────┘

結果: 320×240 のキャンバスに
     顔と手が可視化される
```

---

## 完全な処理シーケンス図（ユーザー操作編）

```
ユーザー操作の流れ

[1] コンポーネントマウント
    ↓
[2] enabled=true, monitorOn=true に設定
    ↓
    useEffect 実行
    ↓
[3] 初期化開始
    ↓
    モデル読み込み (1-3秒)
    カメラ起動
    ↓
[4] badge: INIT → ACTIVE
    ↓
[5] メインループ開始
    loop() が 60fps で実行
    (フレーム間引き：実質 12.5fps)
    ↓
[6] リアルタイム推論
    ・顔検出 毎フレーム
    ・手ランドマーク毎フレーム
    ・ジェスチャ判定 毎フレーム
    ↓
[7] ユーザー操作
    │
    ├─ A) グージェスチャ
    │     ↓
    │     onFist() 発火
    │     ↓
    │     親で timerStateNum: 0→1 (中断)
    │     ↓
    │     タイマー中断
    │
    ├─ B) パージェスチャ
    │     ↓
    │     onPalm() 発火
    │     ↓
    │     親で timerStateNum: 1→0 (再開)
    │     ↓
    │     タイマー再開
    │
    └─ C) 顔が10秒見えない
          ↓
          onAway() 発火
          ↓
          親で timerStateNum: 0→1 (自動中断)
          ↓
          タイマー自動中断

[8] ユーザーがトグルを OFF
    ↓
    monitorOn=false
    ↓
    useEffect cleanup() 実行
    ↓
[9] リソース全破棄
    ・カメラ停止
    ・モデルクローズ
    ・ストリーム停止
    ↓
[10] loop() 停止
     badge: INIT または IDLE
     ↓
    推論完全停止
```

---

## 🔑 重要なポイント

### メモリ管理
- ✅ ref を使用 → 不要な再レンダリング防止
- ✅ useCallback で memo 化 → 依存最小化
- ✅ cleanup で全リソース破棄 → メモリリーク防止

### パフォーマンス
- ✅ フレーム間引き (80ms ≈ 12.5fps)
- ✅ 二重初期化防止 (StrictMode 対応)
- ✅ race condition 対策 (cancelled フラグ)

### ジェスチャ精度
- ✅ 複合判定 (距離計算)
- ✅ クールダウン (誤検出防止)
- ✅ 安定化フレームカウント (ノイズ低減)

### UX
- ✅ 状態表示 (バッジ + テキスト)
- ✅ カウントダウン表示 (10秒→中断)
- ✅ エラーメッセージ (カメラ権限)
- ✅ デバッグプレビュー (顔矩形 + ランドマーク)

